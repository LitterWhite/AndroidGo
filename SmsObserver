package com.example.yanzm;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import android.annotation.SuppressLint;
import android.content.Context;
import android.database.ContentObserver;
import android.database.Cursor;
import android.net.Uri;
import android.os.Handler;
import android.util.Log;

@SuppressLint("NewApi") public class SmsObserver extends ContentObserver {
	
	private Context mContext;
	private Handler mHandler;

	public SmsObserver(Context context,Handler handler) {
		super(handler);
		// TODO Auto-generated constructor stub
		mContext = context;
		mHandler = handler;
	}
	
	@Override
	public void onChange(boolean selfChange,Uri uri){
		super.onChange(selfChange,uri);
		
		Log.e("DEBUG","SMS has changed!");
		Log.e("DEBUG",uri.toString());
		
		String code;
		
		if(uri.toString().equals("content://sms/raw")){
			return;
		}
		
		System.out.println("success3");

		Uri inboxUri = Uri.parse("content://sms/inbox");
		Cursor c = mContext.getContentResolver().query(inboxUri,null,null,null,"date desc");
		System.out.println("success4");
		try{
			if( c != null ){
				if(c.moveToFirst()){
					String address = c.getString(c.getColumnIndex("address"));
					String body = c.getString(c.getColumnIndex("body"));
				
					Log.e("DEBUG","发件人："+address+" 内容："+body);
				
					Pattern pattern = Pattern.compile("(\\d{6})");
					Matcher matcher = pattern.matcher(body);
				
					if(matcher.find()){
						code = matcher.group(0);
						Log.e("DEBUG","code is "+code);
					
						mHandler.obtainMessage(MainActivity.MSG_RECEIVED_CODE, code).sendToTarget();
					}
				}
			}
			c.close();
		}catch (Exception e) {
	        e.printStackTrace();
	    }
	}

}
